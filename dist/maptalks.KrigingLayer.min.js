/*!
 * maptalks.KrigingLayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@^0.25.0 
 */
!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],r):r(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,r){"use strict";function e(t,r){for(var e=Object.getOwnPropertyNames(r),o=0;o<e.length;o++){var n=e[o],i=Object.getOwnPropertyDescriptor(r,n);i&&i.configurable&&void 0===t[n]&&Object.defineProperty(t,n,i)}return t}function o(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function n(t,r){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?t:r}function i(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);t.prototype=Object.create(r&&r.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(t,r):e(t,r))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var t=void 0,r=void 0;for(t=0,r=0;t<this.length;t++)r+=this[t];return r/this.length},Array.prototype.rep=function(t){return Array.apply(null,new Array(t)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(t,r){var e=void 0,o=void 0,n=!1;for(e=0,o=this.length-1;e<this.length;o=e++)this[e][1]>r!=this[o][1]>r&&t<(this[o][0]-this[e][0])*(r-this[e][1])/(this[o][1]-this[e][1])+this[e][0]&&(n=!n);return n};var a={},p=function(t,r){var e=void 0,o=[0].rep(r*r);for(e=0;e<r;e++)o[e*r+e]=t;return o},s=function(t,r,e){var o=void 0,n=void 0,i=Array(e*r);for(o=0;o<r;o++)for(n=0;n<e;n++)i[n*r+o]=t[o*e+n];return i},f=function(t,r,e,o){var n=void 0,i=void 0,a=Array(e*o);for(n=0;n<e;n++)for(i=0;i<o;i++)a[n*o+i]=t[n*o+i]+r[n*o+i];return a},l=function(t,r,e,o,n){var i=void 0,a=void 0,p=void 0,s=Array(e*n);for(i=0;i<e;i++)for(a=0;a<n;a++)for(s[i*n+a]=0,p=0;p<o;p++)s[i*n+a]+=t[i*o+p]*r[p*n+a];return s},h=function(t,r){var e=void 0,o=void 0,n=void 0,i=Array(r);for(e=0;e<r;e++)i[e]=t[e*r+e];for(e=0;e<r;e++){for(o=0;o<e;o++)i[e]-=t[e*r+o]*t[e*r+o];if(i[e]<=0)return!1;for(i[e]=Math.sqrt(i[e]),o=e+1;o<r;o++){for(n=0;n<e;n++)t[o*r+e]-=t[o*r+n]*t[e*r+n];t[o*r+e]/=i[e]}}for(e=0;e<r;e++)t[e*r+e]=i[e];return!0},u=function(t,r){var e=void 0,o=void 0,n=void 0,i=void 0;for(e=0;e<r;e++)for(t[e*r+e]=1/t[e*r+e],o=e+1;o<r;o++){for(i=0,n=e;n<o;n++)i-=t[o*r+n]*t[n*r+e];t[o*r+e]=i/t[o*r+o]}for(e=0;e<r;e++)for(o=e+1;o<r;o++)t[e*r+o]=0;for(e=0;e<r;e++){for(t[e*r+e]*=t[e*r+e],n=e+1;n<r;n++)t[e*r+e]+=t[n*r+e]*t[n*r+e];for(o=e+1;o<r;o++)for(n=o;n<r;n++)t[e*r+o]+=t[n*r+e]*t[n*r+o]}for(e=0;e<r;e++)for(o=0;o<e;o++)t[e*r+o]=t[o*r+e]},c=function(t,r){var e=r,o=Array(r*r),n=Array(r),i=Array(r),a=Array(r),p=void 0,s=void 0,f=void 0,l=void 0,h=void 0,u=void 0,c=void 0,d=void 0,y=void 0,g=void 0,v=void 0;for(p=0;p<r;p++)for(l=0;l<r;l++)o[p*r+l]=p==l?1:0;for(l=0;l<r;l++)a[l]=0;for(p=0;p<r;p++){for(d=0,l=0;l<r;l++)if(1!=a[l])for(h=0;h<r;h++)0==a[h]&&Math.abs(t[l*r+h])>=d&&(d=Math.abs(t[l*r+h]),f=l,s=h);if(++a[s],f!=s){for(u=0;u<r;u++)v=t[f*r+u],t[f*r+u]=t[s*r+u],t[s*r+u]=v;for(u=0;u<e;u++)v=o[f*r+u],o[f*r+u]=o[s*r+u],o[s*r+u]=v}if(i[p]=f,n[p]=s,0==t[s*r+s])return!1;for(g=1/t[s*r+s],t[s*r+s]=1,u=0;u<r;u++)t[s*r+u]*=g;for(u=0;u<e;u++)o[s*r+u]*=g;for(c=0;c<r;c++)if(c!=s){for(y=t[c*r+s],t[c*r+s]=0,u=0;u<r;u++)t[c*r+u]-=t[s*r+u]*y;for(u=0;u<e;u++)o[c*r+u]-=o[s*r+u]*y}}for(u=r-1;u>=0;u--)if(i[u]!=n[u])for(h=0;h<r;h++)v=t[h*r+i[u]],t[h*r+i[u]]=t[h*r+n[u]],t[h*r+n[u]]=v;return!0},d=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*Math.pow(t/e,2)))},y=function(t,r,e,o,n){return r+(o-r)/e*(1-Math.exp(-1/n*(t/e)))},g=function(t,r,e,o,n){return t>e?r+(o-r)/e:r+(o-r)/e*(t/e*1.5-.5*Math.pow(t/e,3))};a.train=function(t,r,e,o,n,i){var a={t:t,x:r,y:e,nugget:0,range:0,sill:0,A:1/3,n:0};switch(o){case"gaussian":a.model=d;break;case"exponential":a.model=y;break;case"spherical":a.model=g}var v=void 0,m=void 0,w=void 0,M=void 0,A=t.length,x=Array((A*A-A)/2);for(v=0,w=0;v<A;v++)for(m=0;m<v;m++,w++)x[w]=Array(2),x[w][0]=Math.pow(Math.pow(r[v]-r[m],2)+Math.pow(e[v]-e[m],2),.5),x[w][1]=Math.abs(t[v]-t[m]);x.sort(function(t,r){return t[0]-r[0]}),a.range=x[(A*A-A)/2-1][0];var b=(A*A-A)/2>30?30:(A*A-A)/2,O=a.range/b,R=[0].rep(b),E=[0].rep(b);if(b<30)for(M=0;M<b;M++)R[M]=x[M][0],E[M]=x[M][1];else{for(v=0,m=0,w=0,M=0;v<b&&m<(A*A-A)/2;v++,w=0){for(;x[m][0]<=(v+1)*O&&(R[M]+=x[m][0],E[M]+=x[m][1],m++,w++,!(m>=(A*A-A)/2)););w>0&&(R[M]/=w,E[M]/=w,M++)}if(M<2)return a}A=M,a.range=R[A-1]-R[0];var _=[1].rep(2*A),k=Array(A),C=a.A;for(v=0;v<A;v++){switch(o){case"gaussian":_[2*v+1]=1-Math.exp(-1/C*Math.pow(R[v]/a.range,2));break;case"exponential":_[2*v+1]=1-Math.exp(-1/C*R[v]/a.range);break;case"spherical":_[2*v+1]=R[v]/a.range*1.5-.5*Math.pow(R[v]/a.range,3)}k[v]=E[v]}var j=s(_,A,2),z=l(j,_,2,A,2);z=f(z,p(1/i,2),2,2);var D=z.slice(0);h(z,2)?u(z,2):(c(D,2),z=D);var T=l(l(z,j,2,2,A),k,2,A,1);a.nugget=T[0],a.sill=T[1]*a.range+a.nugget,a.n=r.length,A=r.length;var K=Array(A*A);for(v=0;v<A;v++){for(m=0;m<v;m++)K[v*A+m]=a.model(Math.pow(Math.pow(r[v]-r[m],2)+Math.pow(e[v]-e[m],2),.5),a.nugget,a.range,a.sill,a.A),K[m*A+v]=K[v*A+m];K[v*A+v]=a.model(0,a.nugget,a.range,a.sill,a.A)}var N=f(K,p(n,A),A,A),P=N.slice(0);h(N,A)?u(N,A):(c(P,A),N=P);var S=N.slice(0),L=l(N,t,A,A,1);return a.K=S,a.M=L,a},a.predict=function(t,r,e){var o=void 0,n=Array(e.n);for(o=0;o<e.n;o++)n[o]=e.model(Math.pow(Math.pow(t-e.x[o],2)+Math.pow(r-e.y[o],2),.5),e.nugget,e.range,e.sill,e.A);return l(n,e.M,1,e.n,1)[0]},a.variance=function(t,r,e){var o=void 0,n=Array(e.n);for(o=0;o<e.n;o++)n[o]=e.model(Math.pow(Math.pow(t-e.x[o],2)+Math.pow(r-e.y[o],2),.5),e.nugget,e.range,e.sill,e.A);return e.model(0,e.nugget,e.range,e.sill,e.A)+l(l(n,e.K,1,e.n,e.n),n,1,e.n,1)[0]},a.grid=function(t,r,e){var o=void 0,n=void 0,i=void 0,p=t.length;if(0!=p){var s=[t[0][0][0],t[0][0][0]],f=[t[0][0][1],t[0][0][1]];for(o=0;o<p;o++)for(n=0;n<t[o].length;n++)t[o][n][0]<s[0]&&(s[0]=t[o][n][0]),t[o][n][0]>s[1]&&(s[1]=t[o][n][0]),t[o][n][1]<f[0]&&(f[0]=t[o][n][1]),t[o][n][1]>f[1]&&(f[1]=t[o][n][1]);var l=void 0,h=void 0,u=Array(2),c=Array(2),d=Array(2),y=Array(2),g=Math.ceil((s[1]-s[0])/e),v=Math.ceil((f[1]-f[0])/e),m=Array(g+1);for(o=0;o<=g;o++)m[o]=Array(v+1);for(o=0;o<p;o++){for(d[0]=t[o][0][0],d[1]=d[0],y[0]=t[o][0][1],y[1]=y[0],n=1;n<t[o].length;n++)t[o][n][0]<d[0]&&(d[0]=t[o][n][0]),t[o][n][0]>d[1]&&(d[1]=t[o][n][0]),t[o][n][1]<y[0]&&(y[0]=t[o][n][1]),t[o][n][1]>y[1]&&(y[1]=t[o][n][1]);for(u[0]=Math.floor((d[0]-(d[0]-s[0])%e-s[0])/e),u[1]=Math.ceil((d[1]-(d[1]-s[1])%e-s[0])/e),c[0]=Math.floor((y[0]-(y[0]-f[0])%e-f[0])/e),c[1]=Math.ceil((y[1]-(y[1]-f[1])%e-f[0])/e),n=u[0];n<=u[1];n++)for(i=c[0];i<=c[1];i++)l=s[0]+n*e,h=f[0]+i*e,t[o].pip(l,h)&&(m[n][i]=a.predict(l,h,r))}return m.xlim=s,m.ylim=f,m.zlim=[r.t.min(),r.t.max()],m.width=e,m}},a.contour=function(t,r,e){return null},a.plot=function(t,r,e,o,n){var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);var a=[e[1]-e[0],o[1]-o[0],r.zlim[1]-r.zlim[0]],p=void 0,s=void 0,f=void 0,l=void 0,h=void 0,u=r.length,c=r[0].length,d=Math.ceil(r.width*t.width/(e[1]-e[0])),y=Math.ceil(r.width*t.height/(o[1]-o[0]));for(p=0;p<u;p++)for(s=0;s<c;s++)void 0!=r[p][s]&&(f=t.width*(p*r.width+r.xlim[0]-e[0])/a[0],l=t.height*(1-(s*r.width+r.ylim[0]-o[0])/a[1]),h=(r[p][s]-r.zlim[0])/a[2],h<0&&(h=0),h>1&&(h=1),i.fillStyle=n[Math.floor((n.length-1)*h)],i.fillRect(Math.round(f-d/2),Math.round(l-y/2),d,y))};var v=function(t,r){return add(t,r)},m={addd:v,kriging:a},w={width:.001,model:"exponential",sigma2:0,alpha:10},M=function(t){function e(r,i,a){o(this,e),Array.isArray(i)||(a=i,i=null);var p=n(this,t.call(this,r,a));return p._interest=i||[],p}return i(e,t),e.prototype.getData=function(){return this._interest},e.prototype.setData=function(t){return this._interest=t||[],this.redraw()},e.prototype.onConfig=function(r){t.prototype.onConfig.apply(this,arguments);for(var e in r)if(w[e])return this.redraw();return this},e.prototype.redraw=function(){var t=this._getRenderer();return t&&(t.clearHeatCache(),t.setToRedraw()),this},e.prototype.isEmpty=function(){return!this._interest.length},e.prototype.clear=function(){return this._interest=[],this.redraw(),this.fire("clear"),this},e.prototype.toJSON=function(t){t||(t={});var e={type:this.getJSONType(),id:this.getId(),options:this.config()},o=this.getData();if(t.clipExtent){var n=new r.Extent(t.clipExtent),i=this._getHeatRadius();i&&(n=n._expand(i));for(var a=[],p=0,s=o.length;p<s;p++)n.contains(new r.Coordinate(o[p][0],o[p][1]))&&a.push(o[p]);e.data=a}else e.data=o;return e},e.fromJSON=function(t){return t&&"KrigingLayer"===t.type?new e(t.id,t.data,t.options):null},e}(r.Layer);M.mergeOptions(w),M.registerJSONType("KrigingLayer"),M.registerRenderer("canvas",function(t){function r(){return o(this,r),n(this,t.apply(this,arguments))}return i(r,t),r.prototype.needToRedraw=function(){var r=this.layer.getMap();return!r.isZooming()&&(!r.isMoving()&&t.prototype.needToRedraw.call(this))},r.prototype.draw=function(){if(this.prepareCanvas(),!this._isInExtent())return void this.completeRender();this._plot(),this.completeRender()},r.prototype.drawOnInteracting=function(){this.draw()},r.prototype._plot=function(){var t=this.layer.getMap(),r=this.layer.options.width,e=this.layer.options.colors,o=this.layer.options.regions,n=this.layer.options.model,i=this.layer.options.sigma2,a=this.layer.options.alpha,p=this._handRegions(o),s=t.getExtent(),f=this.layer.getData(),l=f.map(function(t){return t[0]}),h=f.map(function(t){return t[1]}),u=f.map(function(t){return t[2]}),c=m.kriging.train(u,l,h,n,i,a),d=m.kriging.grid(p,c,r);m.kriging.plot(this.canvas,d,[s.xmin,s.xmax],[s.ymin,s.ymax],e)},r.prototype._isInExtent=function(){var t=this.layer.getMap(),r=t.getExtent(),e=this.layer.options.regions,o=e.getExtent();return!!r.intersects(o)},r.prototype.onZoomEnd=function(){t.prototype.onZoomEnd.apply(this,arguments)},r.prototype.onResize=function(){t.prototype.onResize.apply(this,arguments)},r.prototype.onDragRotateEnd=function(r){t.prototype.onDragRotateEnd.call(this,r)},r.prototype.resizeCanvas=function(){this.canvas},r.prototype.clearCanvas=function(){this.canvas},r.prototype._handRegions=function(t){return t.getCoordinates().map(function(t){return t.map(function(t){return[t.x,t.y]})})},r}(r.renderer.CanvasRenderer)),t.KrigingLayer=M,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.KrigingLayer v0.1.0, requires maptalks@^0.25.0.")});